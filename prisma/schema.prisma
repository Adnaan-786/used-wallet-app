// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../backend/node_modules/.prisma/client"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

// 1. Users Table
model User {
  id           String   @id @default(auto()) @map("_id") @db.ObjectId
  uid_username String?  @default(uuid()) // Auto-generated unique username
  email        String   @unique
  phone_number String?  // Backend-only, nullable if not strictly required on signup
  password     String
  isAdmin      Boolean  @default(false)
  created_at   DateTime? @default(now())
  updated_at   DateTime? @updatedAt

  // Relations
  wallet       Wallet?
  topups       TopUp[]
  withdrawals  Withdrawal[]
  trades       Trade[]

  @@map("users")
}

// 2. Wallets Table (The Ledger)
model Wallet {
  id                String   @id @default(auto()) @map("_id") @db.ObjectId
  user_id           String   @unique @db.ObjectId
  balance_total     Float    @default(0.00000000)
  balance_available Float    @default(0.00000000)
  balance_frozen    Float    @default(0.00000000)
  trc20_address     String?  // The user's deposit address
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id])

  @@map("wallets")
}

// 3. TopUps Table
model TopUp {
  id              String      @id @default(auto()) @map("_id") @db.ObjectId
  user_id         String      @db.ObjectId
  amount          Float
  order_no        String      @unique
  screenshot_path String?
  tx_id_15        String      @unique
  status          TxStatus    @default(PROCESSING)
  created_at      DateTime    @default(now())
  updated_at      DateTime    @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id])

  @@map("topups")
}

// 4. Withdrawals Table
model Withdrawal {
  id             String      @id @default(auto()) @map("_id") @db.ObjectId
  user_id        String      @db.ObjectId
  amount         Float
  order_no       String      @unique
  wallet_address String      // External wallet address to send funds to
  status         TxStatus    @default(PROCESSING)
  created_at     DateTime    @default(now())
  updated_at     DateTime    @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id])

  @@map("withdrawals")
}

// 5. Trades Table (Sell Requests)
model Trade {
  id                     String   @id @default(auto()) @map("_id") @db.ObjectId
  user_id                String   @db.ObjectId
  country                String
  unit_price             Float
  units                  Float // USDT amount
  total_amount_local     Float // Fiat amount
  payment_method_details Json     // Stores varying bank/UPI details
  status                 TxStatus @default(PROCESSING)
  created_at             DateTime @default(now())
  updated_at             DateTime @updatedAt

  // Relations
  user User @relation(fields: [user_id], references: [id])

  @@map("trades")
}

enum TxStatus {
  PROCESSING
  COMPLETED
  FAILED
}
